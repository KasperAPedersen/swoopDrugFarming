local plantingSpots = {
    -- || Row 1
    { x = 2238.2021484375, y = 5573.9409179688, z = 53.865348815918, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2236.0390625, y = 5574.1259765625, z = 53.92749786377, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2233.3854980469, y = 5574.2001953125, z = 53.996948242188, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2230.8327636719, y = 5574.400390625, z = 53.912696838379, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2228.3935546875, y = 5574.5512695313, z = 53.841316223145, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2225.8779296875, y = 5574.5913085938, z = 53.783382415771, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2223.6208496094, y = 5574.9204101563, z = 53.73352432251, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2221.0349121094, y = 5574.9653320313, z = 53.725147247314, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2218.5666503906, y = 5575.0498046875, z = 53.726181030273, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2216.3037109375, y = 5575.328125, z = 53.702667236328, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2213.5249023438, y = 5575.3642578125, z = 53.673782348633, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2210.8103027344, y = 5575.6079101563, z = 53.760807037354, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },

    -- || Row 2
    { x = 2210.8891601563, y = 5577.9438476563, z = 53.893783569336, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2214.0051269531, y = 5577.6748046875, z = 53.816318511963, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2216.3073730469, y = 5577.5805664063, z = 53.83918762207, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2218.9125976563, y = 5577.35546875, z = 53.856292724609, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2221.1337890625, y = 5577.2690429688, z = 53.847545623779, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2223.5493164063, y = 5577.0678710938, z = 53.846969604492, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2225.728515625, y = 5576.7788085938, z = 53.853778839111, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2228.4074707031, y = 5576.8022460938, z = 53.891990661621, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2230.5739746094, y = 5576.484375, z = 53.966423034668, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2232.8608398438, y = 5576.4848632813, z = 54.041316986084, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2236.1997070313, y = 5576.3779296875, z = 54.037620544434, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2237.9965820313, y = 5576.244140625, z = 54.020130157471, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },

    -- || Row 3
    { x = 2238.7282714844, y = 5578.4638671875, z = 54.072750091553, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2236.8012695313, y = 5578.5141601563, z = 54.093887329102, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2233.8767089844, y = 5578.6020507813, z = 54.122650146484, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2231.3249511719, y = 5578.9165039063, z = 54.052043914795, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2228.6333007813, y = 5579.1318359375, z = 53.96898651123, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2226.2233886719, y = 5579.1733398438, z = 53.945327758789, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2223.9990234375, y = 5579.2963867188, z = 53.931224822998, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2221.6345214844, y = 5579.3935546875, z = 53.941822052002, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2219.3405761719, y = 5579.7451171875, z = 53.957576751709, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2216.8110351563, y = 5579.6499023438, z = 53.961132049561, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2214.1735839844, y = 5579.873046875, z = 53.940807342529, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 },
    { x = 2211.2761230469, y = 5579.99609375, z = 54.022274017334, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 10, stage = 0, spawned = 0 }
}

-- || Stage 0 -> not seeded
-- || Stage 1 -> seeded
-- || Stage 2 -> growing (prop_weed_02)
-- || Stage 3 -> Almost finish (prop_weed_01)
-- || Stage 4 -> Finished

-- || Handle player pos -> plating spot pos
    -- || If stage 0 -> Allow player to plant
        -- || If seed amount > 0 -> plant seed
    -- || Elseif stage 1|2|3 -> Disallow player to do anything on plant
    -- || Elseif stage 4 -> Allow player to take plant

local seedAmount = 0
Citizen.CreateThread(function()
    while true do
        Citizen.Wait(0)
        for key,value in pairs(plantingSpots) do
            if GetDistanceBetweenCoords(GetEntityCoords(GetPlayerPed(-1)), value.x, value.y, value.z, true) <= 1.0 then
                --DrawText3Ds(value.x, value.y, value.z, "Spot " .. key .. " | " .. value.stage)
                if value.stage == 0 then
                    DrawText3Ds(value.x, value.y, value.z, "Klik ~g~E~w~ for at plante ~g~marihuana frÃ¸~w~") -- || Display 'plant seed text'
                    if IsControlJustReleased(1, 38) then
                        --print("AM: " .. seedAmount)
                        if seedAmount > 0 then
                            -- || Plant seed -> handle server side -> return plant information from server
                            plantSeed(key)
                        end
                    end
                elseif value.stage == 1 or value.stage == 2 or value.stage == 3 then
                    DrawText3Ds(value.x, value.y, value.z, "Planten gror | Tid tilbage (~g~" .. value.timeLeft .. "~w~)") -- || Display 'waiting text'
                elseif value.stage == 4 then
                    DrawText3Ds(value.x, value.y, value.z, "Klik ~g~E~w~ for at grave planten op") -- || Display 'Take finished plant text'
                    -- || Take plant -> Delete server side -> remove plant information on each client
                    if IsControlJustReleased(1, 38) then
                        takePlant(key)
                    end
                end
            end
        end
    end
end)

function plantSeed(spot)
    TaskStartScenarioInPlace(GetPlayerPed(-1), "WORLD_HUMAN_GARDENER_PLANT", 0, true)
    FreezeEntityPosition(GetPlayerPed(-1),true)
    Citizen.Wait(10000)
    FreezeEntityPosition(GetPlayerPed(-1),false)
    ClearPedTasksImmediately(GetPlayerPed(-1))
    TriggerServerEvent('addPlant', spot) -- marihuanaSeed
end

function takePlant(spot)
    TaskStartScenarioInPlace(GetPlayerPed(-1), "PROP_HUMAN_BUM_BIN", 0, true)
    FreezeEntityPosition(GetPlayerPed(-1),true)
    Citizen.Wait(10000)
    PlaySoundFrontend(-1, 'PICK_UP', 'HUD_FRONTEND_DEFAULT_SOUNDSET', false)
    FreezeEntityPosition(GetPlayerPed(-1),false)
    ClearPedTasksImmediately(GetPlayerPed(-1))
    TriggerServerEvent('takeFinishedPlant', spot) -- marihuanaSeed
end

-- || Check each close client's inventory for seeds
Citizen.CreateThread(function()
    while true do
        Citizen.Wait(500)
        local isCloseToSpot = false
        for key,value in pairs(plantingSpots) do
            if GetDistanceBetweenCoords(GetEntityCoords(GetPlayerPed(-1)), value.x, value.y, value.z, true) < 20.0 then
                isCloseToSpot = true
            end
        end

        if isCloseToSpot then
            TriggerServerEvent('checkAmountOfSeedsInPlayerInventory', "marihuanaSeed") -- marihuanaSeed
            isCloseToSpot = false
        end
    end
end)

RegisterNetEvent("getAmountOfSeedsInPlayerInventory")
AddEventHandler("getAmountOfSeedsInPlayerInventory", function(amount)
    seedAmount = amount
end)


-- || Get returning plant information
RegisterNetEvent("getPlantInformation")
AddEventHandler("getPlantInformation", function(spot, stage, timeLeft)
    if spot ~= nil and stage ~= nil and timeLeft ~= nil then
        plantingSpots[spot].stage = stage
        plantingSpots[spot].timeLeft = timeLeft
    end
end)


-- || Get finished plant
RegisterNetEvent("getFinishedPlantInformation")
AddEventHandler("getFinishedPlantInformation", function(spot)
    if spot ~= nil then
        plantingSpots[spot].stage = 4
        plantingSpots[spot].timeLeft = 0
    end
end)

-- || Place plant in world
RegisterNetEvent("placePlant")
AddEventHandler("placePlant", function(spot, model)
    if spot ~= nil and model ~= nil then
        local obj = GetClosestObjectOfType(plantingSpots[spot].x, plantingSpots[spot].y, plantingSpots[spot].z, 1.5, GetHashKey(model), false, false, false)
        --print("pp obj: " .. obj)
        if obj == 0 then
            --print("placing plant")
            TriggerServerEvent('getPlantSpawned', spot)
            Citizen.Wait(250)
            if plantingSpots[spot].spawned == 0 then
                obj = CreateObject(GetHashKey(model), plantingSpots[spot].x, plantingSpots[spot].y, plantingSpots[spot].z, true, true, true)
                PlaceObjectOnGroundProperly(obj)
                SetEntityRotation(obj, 0.00, 0.00, 340.00)
                FreezeEntityPosition(obj, true)
            end
        end
    end
end)

-- || Replace plant in world
RegisterNetEvent("replacePlant")
AddEventHandler("replacePlant", function(spot, oldModel, newModel)
    if spot ~= nil and oldModel ~= nil and newModel ~= nil then
        local newObj = GetClosestObjectOfType(plantingSpots[spot].x, plantingSpots[spot].y, plantingSpots[spot].z, 1.5, GetHashKey(newModel), false, false, false)
        if newObj == 0 then
            local obj = GetClosestObjectOfType(plantingSpots[spot].x, plantingSpots[spot].y, plantingSpots[spot].z, 1.5, GetHashKey(oldModel), false, false, false)
            if obj ~= 0 then -- || Object found
                DeleteEntity(obj)
                TriggerServerEvent('getPlantSpawned', spot)
                Citizen.Wait(250)
                if plantingSpots[spot].spawned == 0 then
                    newObj = CreateObject(GetHashKey(newModel), plantingSpots[spot].x, plantingSpots[spot].y, plantingSpots[spot].z, true, true, true)
                    PlaceObjectOnGroundProperly(newObj)
                    SetEntityRotation(newObj, 0.00, 0.00, 340.00)
                    FreezeEntityPosition(newObj, true)
                end
            else
                TriggerServerEvent('getPlantSpawned', spot)
                Citizen.Wait(250)
                if plantingSpots[spot].spawned == 0 then
                    newObj = CreateObject(GetHashKey(newModel), plantingSpots[spot].x, plantingSpots[spot].y, plantingSpots[spot].z, true, true, true)
                    PlaceObjectOnGroundProperly(newObj)
                    SetEntityRotation(newObj, 0.00, 0.00, 340.00)
                    FreezeEntityPosition(newObj, true)
                end
            end
        end
    end
end)

-- || Place plant in world
RegisterNetEvent("removePlant")
AddEventHandler("removePlant", function(spot, model)
    if spot ~= nil and model ~= nil then
        local obj = GetClosestObjectOfType(plantingSpots[spot].x, plantingSpots[spot].y, plantingSpots[spot].z, 1.0, GetHashKey(model), false, false, false)
        if obj ~= 0 then
            DeleteEntity(obj)
        end
    end
end)

-- || Accept plant removal
RegisterNetEvent("acceptPlantRemoval")
AddEventHandler("acceptPlantRemoval", function()
    TriggerServerEvent('giveItemToPlayer', "marihuanaPlant", 1)
end)

-- || Accept plant added
RegisterNetEvent("acceptPlantAdding")
AddEventHandler("acceptPlantAdding", function(spot)
    TriggerServerEvent('takeItemFromInventory', "marihuanaSeed", 1)
    local obj = GetClosestObjectOfType(plantingSpots[spot].x, plantingSpots[spot].y, plantingSpots[spot].z, 1.0, GetHashKey("prop_weed_01"), false, false, false)
    if obj ~= 0 then -- || Object found
        DeleteEntity(obj)
        newObj = CreateObject(GetHashKey("prop_weed_01"), plantingSpots[spot].x, plantingSpots[spot].y, plantingSpots[spot].z, true, true, true)
        PlaceObjectOnGroundProperly(newObj)
        SetEntityRotation(newObj, 0.00, 0.00, 340.00)
        FreezeEntityPosition(newObj, true)
    else
        newObj = CreateObject(GetHashKey("prop_weed_01"), plantingSpots[spot].x, plantingSpots[spot].y, plantingSpots[spot].z, true, true, true)
        PlaceObjectOnGroundProperly(newObj)
        SetEntityRotation(newObj, 0.00, 0.00, 340.00)
        FreezeEntityPosition(newObj, true)
    end
end)

-- || REturn spawned status
RegisterNetEvent("returnSpawnStatus")
AddEventHandler("returnSpawnStatus", function(spot, status)
    if spot ~= nil and status ~= nil then
        plantingSpots[spot].spawned = status
    end
end)

-- |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||| TRIM PLANT
local plantAmount = 0
local trimmingSpots = {
    { x = 2195.8090820313, y = 5594.3188476563, z = 53.770412445068, drawMarkerType = 2, drawMarkerColour = {0, 0, 0, 50}, timeLeft = 5, currentlyTrimming = false, heading = 253.0 }
}

Citizen.CreateThread(function()
    while true do
        Citizen.Wait(0)
        for key,value in pairs(trimmingSpots) do
            --DrawMarker(value.drawMarkerType, value.x, value.y, value.z + 0.5, 0.0, 0.0, 0.0, 0.0, 180.0, 0.0, 1.5, 1.5, 1.5, 0,0,0,50, true, true, 2, nil, nil, false)
            if GetDistanceBetweenCoords(GetEntityCoords(GetPlayerPed(-1)), value.x, value.y, value.z, true) <= 1.0 and not value.currentlyTrimming then
                DrawText3Ds(value.x, value.y, value.z, "Klik ~g~E~w~ for at trimme din marihuana plante (planter: " .. plantAmount .. ")")
                if IsControlJustReleased(1, 38) and plantAmount > 0 then
                    -- || Start trimming
                    startTrimming(key)
                end
            elseif GetDistanceBetweenCoords(GetEntityCoords(GetPlayerPed(-1)), value.x, value.y, value.z, true) <= 1.0 and value.currentlyTrimming then
                DrawText3Ds(value.x, value.y, value.z, "Status: Trimming | Tid tilbage: (" .. value.timeLeft .. ")")
            end
        end
    end
end)

Citizen.CreateThread(function()
    while true do
        Citizen.Wait(1000)
        for key,value in pairs(trimmingSpots) do
            if value.currentlyTrimming then
                if GetDistanceBetweenCoords(GetEntityCoords(GetPlayerPed(-1)), value.x, value.y, value.z, true) <= 1.0 then
                    if value.timeLeft <= 0 then -- || finished
                        value.timeLeft = 5
                        value.currentlyTrimming = false
    
                        -- || Finish trimming
                        finishTrimming(true)
                    else
                        value.timeLeft = value.timeLeft - 1
                    end
                else -- || Not on spot, reset trim
                    value.timeLeft = 5
                    value.currentlyTrimming = false

                    -- || Finish trimming
                    finishTrimming(false)
                end
                
            end
        end
    end
end)


-- || Inventory testing for plants
Citizen.CreateThread(function()
    while true do
        Citizen.Wait(500)
        local isCloseToSpot = false
        for key,value in pairs(trimmingSpots) do
            if GetDistanceBetweenCoords(GetEntityCoords(GetPlayerPed(-1)), value.x, value.y, value.z, true) < 20.0 then
                isCloseToSpot = true
            end
        end

        if isCloseToSpot then
            TriggerServerEvent('checkAmountOfPlantsInPlayerInventory', "marihuanaPlant") -- marihuanaSeed
            isCloseToSpot = false
        end
    end
end)

function startTrimming(key)
    local cHeading = GetEntityHeading(GetPlayerPed(-1))
    SetPedDesiredHeading(GetPlayerPed(-1), trimmingSpots[key].heading)

    while (GetEntityHeading(GetPlayerPed(-1)) < trimmingSpots[key].heading - 1) or (GetEntityHeading(GetPlayerPed(-1)) > trimmingSpots[key].heading + 1) do
        Citizen.Wait(250)
        SetPedDesiredHeading(GetPlayerPed(-1), trimmingSpots[key].heading)
    end

    TaskStartScenarioInPlace(GetPlayerPed(-1), "prop_human_parking_meter", 0, true)
    FreezeEntityPosition(GetPlayerPed(-1),true)

    -- || Set trim
    trimmingSpots[key].currentlyTrimming = true

    if GetDistanceBetweenCoords(GetEntityCoords(GetPlayerPed(-1)), trimmingSpots[key].x, trimmingSpots[key].y, trimmingSpots[key].z, true) <= 1.0 then
        -- || Take plant from inventory
        TriggerServerEvent('takeItemFromInventory', "marihuanaPlant", 1)
    end
end

function finishTrimming(giveReward)
    -- || Stop animation
    PlaySoundFrontend(-1, 'PICK_UP', 'HUD_FRONTEND_DEFAULT_SOUNDSET', false)
    FreezeEntityPosition(GetPlayerPed(-1),false)
    ClearPedTasksImmediately(GetPlayerPed(-1))

    if giveReward then
    -- || Give reward
    TriggerServerEvent('giveItemToPlayer', "MarihuanaBag", math.random(1,5))
    end
    
end

RegisterNetEvent("getAmountOfPlantsInPlayerInventory")
AddEventHandler("getAmountOfPlantsInPlayerInventory", function(amount)
    plantAmount = amount
end)

-- || Helper functions
function notification(msg)
	SetNotificationTextEntry('STRING')
	AddTextComponentString(msg) -- B
	DrawNotification(true, false)
end

function DrawText3Ds(x,y,z, text)
    local onScreen,_x,_y=World3dToScreen2d(x,y,z)
    local px,py,pz=table.unpack(GetGameplayCamCoords())
    
    SetTextScale(0.35, 0.35)
    SetTextFont(4)
    SetTextProportional(1)
    SetTextColour(255, 255, 255, 215)
    SetTextEntry("STRING")
    SetTextCentre(1)
    AddTextComponentString(text)
    DrawText(_x,_y)
    local factor = (string.len(text)) / 370
    DrawRect(_x,_y+0.0125, 0.015+ factor, 0.03, 41, 11, 41, 68)
end